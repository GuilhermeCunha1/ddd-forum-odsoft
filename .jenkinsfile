node {
    try{
    stage('Checkout') {
        // Clona o repositório
        git 'https://github.com/GuilhermeCunha1/ddd-forum-odsoft.git'
    }
    stage('Build') {
        // Instala as dependências e roda o build
        if (isUnix()) {
            sh 'npm install'
            sh 'npm run build'
            sh 'npm install jest-junit --save-dev'
            //sh 'npm test --coverage --reporters=jest-junit'
        } else {
            bat 'npm install'
            bat 'npm run build'
        }
    }
    stage('Test') {
        // Executa os testes
        if (isUnix()) {
            sh 'docker-compose up'
            sh 'npm run db:create dev'
            sh 'npm run migrate:dev'
            sh 'npm run test:api'
        } else {
            bat 'npm run test'
        }
    }

   //stage('Results') {
        // Publica os resultados de teste
     //   junit '**/test-results/*.xml'
        // Arquiva os artefatos, se houver
       // archiveArtifacts 'dist/**/*.*'
    //}
}catch (Exception e){
    echo "Erro encontrado: ${e}"
} finally {
        // Isso será executado sempre, seja com sucesso ou falha
        publishHTML (target: [
            reportDir: 'reports', // Diretório onde o arquivo foi salvo
            reportFiles: 'test-report.html', // Nome do arquivo
            reportName: 'Relatório de Testes',
            keepAll: true,
            alwaysLinkToLastBuild: true,
            allowMissing: false
        ])
    }
}
