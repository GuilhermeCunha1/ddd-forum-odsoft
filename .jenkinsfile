node {
    try{
    stage('Checkout') {
        // Clona o repositório
        git 'https://github.com/GuilhermeCunha1/ddd-forum-odsoft.git'
    }
    stage('Build') {
        // Instala as dependências e roda o build
        if (isUnix()) {
            sh 'npm install'
            sh 'npm run build'
            sh 'npm install jest-junit --save-dev'
            //sh 'npm test --coverage --reporters=jest-junit'
        } else {
            bat 'npm install'
            bat 'npm run build'
        }
    }
    stage('Test') {
        // Executa os testes
        if (isUnix()) {
            sh 'docker-compose up'
            sh 'npm run db:create dev'
            sh 'npm run migrate:dev'
            sh 'npm run test --coverage:api'
        } else {
            bat 'npm run test'
        }
    }

   stage('Results') {
        steps {
        sh './jenkins_build.sh'
        junit '*/build/test-results/*.xml'
        step( [ $class: 'JacocoPublisher' ] )
     }
    }
}catch (Exception e){
    echo "Erro encontrado: ${e}"
} finally {
        publishHTML (target: [
            reportDir: 'reports',
            reportFiles: 'test-report.html', 
            reportName: 'Relatório de Testes',
            keepAll: true,
            alwaysLinkToLastBuild: true,
            allowMissing: false
        ])
    }
}

